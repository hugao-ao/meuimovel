import { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "./components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "./components/ui/tabs";
import { Input } from "./components/ui/input";
import { Label } from "./components/ui/label";
import { Button } from "./components/ui/button";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } from 'recharts';
import { Switch } from "./components/ui/switch";
import './App.css';

function formatCurrency(value: number): string {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  }).format(value);
}

function App() {
  // Estados para os valores de entrada
  const [valorImovel, setValorImovel] = useState<number>(150000);
  const [quantoPoupaMes, setQuantoPoupaMes] = useState<number>(500);
  const [aportesAnuais, setAportesAnuais] = useState<number>(2000);
  const [fgtsGuardado, setFgtsGuardado] = useState<number>(5000);
  const [fgtsAnual, setFgtsAnual] = useState<number>(1500);
  const [usarFgts, setUsarFgts] = useState<boolean>(true);
  const [reservaMinima, setReservaMinima] = useState<number>(10000);
  const [reservaAtual, setReservaAtual] = useState<number>(6000);
  const [rentabilidadeCarteira, setRentabilidadeCarteira] = useState<number>(14.65);
  const [rentabilidadeOutra, setRentabilidadeOutra] = useState<number>(0);
  const [reajusteInflacao, setReajusteInflacao] = useState<number>(5.44);
  const [outroReajuste, setOutroReajuste] = useState<number>(0);
  const [prazoDesejado, setPrazoDesejado] = useState<number>(120);
  const [periodoMaximoAnalisado, setPeriodoMaximoAnalisado] = useState<number>(250);
  const [aportesEsporadicos, setAportesEsporadicos] = useState<Array<{mes: number, valor: number}>>([
    { mes: 9, valor: 10000 },
    { mes: 15, valor: 15000 },
    { mes: 80, valor: 20000 }
  ]);
  
  // Estados para os resultados calculados
  const [mesAnalisado, setMesAnalisado] = useState<number>(200);
  const [saldoFgtsFinal, setSaldoFgtsFinal] = useState<number>(0);
  const [reservaFinal, setReservaFinal] = useState<number>(0);
  const [tabelaCalculo, setTabelaCalculo] = useState<Array<any>>([]);
  const [metaAlcancada, setMetaAlcancada] = useState<boolean>(false);
  const [mesAlcancado, setMesAlcancado] = useState<number>(0);
  
  // Estado para controlar a aba ativa
  const [activeTab, setActiveTab] = useState<string>("a-vista");

  // Função para calcular os resultados
  const calcularResultados = () => {
    let reserva = reservaAtual;
    let saldoFgts = fgtsGuardado;
    let valorImovelAtual = valorImovel;
    let dados = [];
    let metaAtingida = false;
    let mesMeta = 0;
    
    for (let mes = 1; mes <= periodoMaximoAnalisado; mes++) {
      // Aplicar rentabilidade mensal na reserva
      const rentabilidadeMensal = rentabilidadeCarteira / 100 / 12;
      reserva = reserva * (1 + rentabilidadeMensal);
      
      // Adicionar aporte mensal
      reserva += quantoPoupaMes;
      
      // Adicionar FGTS mensal se habilitado
      if (usarFgts) {
        const fgtsMensal = fgtsAnual / 12;
        saldoFgts += fgtsMensal;
      }
      
      // Verificar se há aporte esporádico neste mês
      const aporteEsporadico = aportesEsporadicos.find(a => a.mes === mes);
      if (aporteEsporadico) {
        reserva += aporteEsporadico.valor;
      }
      
      // Adicionar aporte anual se for mês múltiplo de 12
      if (mes % 12 === 0) {
        reserva += aportesAnuais;
      }
      
      // Reajustar valor do imóvel pela inflação (mensalmente)
      const reajusteMensal = reajusteInflacao / 100 / 12;
      valorImovelAtual = valorImovelAtual * (1 + reajusteMensal);
      
      // Verificar se a meta foi atingida
      const totalDisponivel = reserva + (usarFgts ? saldoFgts : 0);
      if (totalDisponivel >= valorImovelAtual && !metaAtingida) {
        metaAtingida = true;
        mesMeta = mes;
      }
      
      // Guardar dados para a tabela e gráfico
      if (mes % 5 === 0 || mes === 1 || mes === mesMeta) { // Guardar a cada 5 meses para não sobrecarregar
        dados.push({
          mes,
          reservaInicial: parseFloat(reserva.toFixed(2)),
          saldoFgtsInicio: parseFloat(saldoFgts.toFixed(2)),
          valorImovel: parseFloat(valorImovelAtual.toFixed(2)),
          totalDisponivel: parseFloat((reserva + (usarFgts ? saldoFgts : 0)).toFixed(2)),
          percentualAlcancado: parseFloat(((reserva + (usarFgts ? saldoFgts : 0)) / valorImovelAtual * 100).toFixed(2))
        });
      }
      
      // Atualizar resultados para o mês analisado
      if (mes === mesAnalisado) {
        setSaldoFgtsFinal(saldoFgts);
        setReservaFinal(reserva);
      }
    }
    
    setTabelaCalculo(dados);
    setMetaAlcancada(metaAtingida);
    setMesAlcancado(mesMeta);
  };

  // Calcular resultados quando os valores mudarem
  useEffect(() => {
    calcularResultados();
  }, [
    valorImovel, quantoPoupaMes, aportesAnuais, fgtsGuardado, fgtsAnual, 
    usarFgts, reservaMinima, reservaAtual, rentabilidadeCarteira, 
    rentabilidadeOutra, reajusteInflacao, outroReajuste, prazoDesejado, 
    periodoMaximoAnalisado, aportesEsporadicos, mesAnalisado
  ]);

  // Componente para o formulário de entrada
  const FormularioEntrada = () => (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <Label htmlFor="valorImovel">Valor do Imóvel</Label>
        <Input
          id="valorImovel"
          type="number"
          value={valorImovel}
          onChange={(e) => setValorImovel(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="quantoPoupaMes">Quanto Poupa / Mês</Label>
        <Input
          id="quantoPoupaMes"
          type="number"
          value={quantoPoupaMes}
          onChange={(e) => setQuantoPoupaMes(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="aportesAnuais">Aportes Anuais</Label>
        <Input
          id="aportesAnuais"
          type="number"
          value={aportesAnuais}
          onChange={(e) => setAportesAnuais(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="fgtsGuardado">FGTS Guardado</Label>
        <Input
          id="fgtsGuardado"
          type="number"
          value={fgtsGuardado}
          onChange={(e) => setFgtsGuardado(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="fgtsAnual">FGTS Anual</Label>
        <Input
          id="fgtsAnual"
          type="number"
          value={fgtsAnual}
          onChange={(e) => setFgtsAnual(Number(e.target.value))}
        />
      </div>
      <div className="flex items-center space-x-2 pt-6">
        <Switch
          id="usarFgts"
          checked={usarFgts}
          onCheckedChange={setUsarFgts}
        />
        <Label htmlFor="usarFgts">Usar FGTS?</Label>
      </div>
      <div>
        <Label htmlFor="reservaMinima">Reserva Mínima</Label>
        <Input
          id="reservaMinima"
          type="number"
          value={reservaMinima}
          onChange={(e) => setReservaMinima(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="reservaAtual">Reserva Atual</Label>
        <Input
          id="reservaAtual"
          type="number"
          value={reservaAtual}
          onChange={(e) => setReservaAtual(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="rentabilidadeCarteira">Rentabilidade Carteira (%)</Label>
        <Input
          id="rentabilidadeCarteira"
          type="number"
          step="0.01"
          value={rentabilidadeCarteira}
          onChange={(e) => setRentabilidadeCarteira(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="reajusteInflacao">Reajuste Inflação (%)</Label>
        <Input
          id="reajusteInflacao"
          type="number"
          step="0.01"
          value={reajusteInflacao}
          onChange={(e) => setReajusteInflacao(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="prazoDesejado">Prazo Desejado (meses)</Label>
        <Input
          id="prazoDesejado"
          type="number"
          value={prazoDesejado}
          onChange={(e) => setPrazoDesejado(Number(e.target.value))}
        />
      </div>
      <div>
        <Label htmlFor="mesAnalisado">Mês Analisado</Label>
        <Input
          id="mesAnalisado"
          type="number"
          value={mesAnalisado}
          onChange={(e) => setMesAnalisado(Number(e.target.value))}
        />
      </div>
    </div>
  );

  // Componente para a tabela de memória de cálculo
  const TabelaMemoriaCalculo = () => (
    <div className="overflow-x-auto">
      <table className="w-full border-collapse">
        <thead>
          <tr className="bg-gray-100">
            <th className="border p-2 text-left">Mês</th>
            <th className="border p-2 text-left">Reserva</th>
            <th className="border p-2 text-left">Saldo FGTS</th>
            <th className="border p-2 text-left">Valor Imóvel</th>
            <th className="border p-2 text-left">Total Disponível</th>
            <th className="border p-2 text-left">% Alcançado</th>
          </tr>
        </thead>
        <tbody>
          {tabelaCalculo.map((linha, index) => (
            <tr key={index} className={linha.mes === mesAlcancado ? "bg-green-100" : ""}>
              <td className="border p-2">{linha.mes}</td>
              <td className="border p-2">{formatCurrency(linha.reservaInicial)}</td>
              <td className="border p-2">{formatCurrency(linha.saldoFgtsInicio)}</td>
              <td className="border p-2">{formatCurrency(linha.valorImovel)}</td>
              <td className="border p-2">{formatCurrency(linha.totalDisponivel)}</td>
              <td className="border p-2">{linha.percentualAlcancado}%</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );

  // Componente para os gráficos
  const Graficos = () => (
    <div className="space-y-8">
      <Card>
        <CardHeader>
          <CardTitle>Evolução do Patrimônio vs Valor do Imóvel</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="h-80">
            <ResponsiveContainer width="100%" height="100%">
              <LineChart
                data={tabelaCalculo}
                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
              >
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="mes" label={{ value: 'Mês', position: 'insideBottomRight', offset: -10 }} />
                <YAxis />
                <Tooltip formatter={(value) => formatCurrency(Number(value))} />
                <Legend />
                <Line type="monotone" dataKey="totalDisponivel" name="Total Disponível" stroke="#8884d8" activeDot={{ r: 8 }} />
                <Line type="monotone" dataKey="valorImovel" name="Valor do Imóvel" stroke="#82ca9d" />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Percentual Alcançado ao Longo do Tempo</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="h-80">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={tabelaCalculo}
                margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
              >
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="mes" />
                <YAxis />
                <Tooltip formatter={(value) => `${value}%`} />
                <Legend />
                <Bar dataKey="percentualAlcancado" name="% Alcançado" fill="#8884d8" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </CardContent>
      </Card>
    </div>
  );

  // Componente para os resultados
  const Resultados = () => (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      <Card>
        <CardHeader>
          <CardTitle>Resultados no Mês {mesAnalisado}</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            <div className="flex justify-between">
              <span>Reserva mínima:</span>
              <span>{formatCurrency(reservaMinima)}</span>
            </div>
            <div className="flex justify-between">
              <span>Valor imóvel:</span>
              <span>{formatCurrency(valorImovel)}</span>
            </div>
            <div className="flex justify-between">
              <span>Saldo FGTS final:</span>
              <span>{formatCurrency(saldoFgtsFinal)}</span>
            </div>
            <div className="flex justify-between">
              <span>Reserva final:</span>
              <span>{formatCurrency(reservaFinal)}</span>
            </div>
            <div className="flex justify-between">
              <span>Total disponível:</span>
              <span>{formatCurrency(reservaFinal + (usarFgts ? saldoFgtsFinal : 0))}</span>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Meta de Compra</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            <div className="flex justify-between">
              <span>Meta alcançada?</span>
              <span>{metaAlcancada ? "SIM" : "NÃO"}</span>
            </div>
            {metaAlcancada && (
              <>
                <div className="flex justify-between">
                  <span>Mês alcançado:</span>
                  <span>{mesAlcancado}</span>
                </div>
                <div className="flex justify-between">
                  <span>Anos:</span>
                  <span>{Math.floor(mesAlcancado / 12)}</span>
                </div>
                <div className="flex justify-between">
                  <span>Meses:</span>
                  <span>{mesAlcancado % 12}</span>
                </div>
              </>
            )}
            <div className="flex justify-between">
              <span>Dentro do prazo?</span>
              <span>{metaAlcancada && mesAlcancado <= prazoDesejado ? "SIM" : "NÃO"}</span>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );

  // Componente para a aba de financiamento
  const Financiamento = () => (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle>Simulação de Financiamento</CardTitle>
          <CardDescription>
            Esta funcionalidade está em desenvolvimento. Por favor, utilize a aba "À Vista" para simular a compra do imóvel.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <p>Em breve, você poderá simular diferentes cenários de financiamento imobiliário aqui.</p>
        </CardContent>
      </Card>
    </div>
  );

  return (
    <div className="container mx-auto py-8 px-4">
      <h1 className="text-3xl font-bold mb-6 text-center">Calculadora de Imóvel</h1>
      
      <Tabs defaultValue="a-vista" value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="grid w-full grid-cols-2">
          <TabsTrigger value="a-vista">À Vista</TabsTrigger>
          <TabsTrigger value="financiamento">Financiamento</TabsTrigger>
        </TabsList>
        
        <TabsContent value="a-vista" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Parâmetros</CardTitle>
            </CardHeader>
            <CardContent>
              <FormularioEntrada />
            </CardContent>
          </Card>
          
          <Card>
            <CardHeader>
              <CardTitle>Aportes Esporádicos</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {aportesEsporadicos.map((aporte, index) => (
                  <div key={index} className="grid grid-cols-2 gap-4">
                    <div>
                      <Label htmlFor={`mes-${index}`}>Mês</Label>
                      <Input
                        id={`mes-${index}`}
                        type="number"
                        value={aporte.mes}
                        onChange={(e) => {
                          const novosAportes = [...aportesEsporadicos];
                          novosAportes[index].mes = Number(e.target.value);
                          setAportesEsporadicos(novosAportes);
                        }}
                      />
                    </div>
                    <div>
                      <Label htmlFor={`valor-${index}`}>Valor</Label>
                      <Input
                        id={`valor-${index}`}
                        type="number"
                        value={aporte.valor}
                        onChange={(e) => {
                          const novosAportes = [...aportesEsporadicos];
                          novosAportes[index].valor = Number(e.target.value);
                          setAportesEsporadicos(novosAportes);
                        }}
                      />
                    </div>
                  </div>
                ))}
                <div className="flex space-x-2">
                  <Button 
                    onClick={() => setAportesEsporadicos([...aportesEsporadicos, { mes: 0, valor: 0 }])}
                    variant="outline"
                  >
                    Adicionar Aporte
                  </Button>
                  <Button 
                    onClick={() => {
                      if (aportesEsporadicos.length > 0) {
                        setAportesEsporadicos(aportesEsporadicos.slice(0, -1));
                      }
                    }}
                    variant="outline"
                  >
                    Remover Último
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
          
          <Resultados />
          
          <Card>
            <CardHeader>
              <CardTitle>Gráficos</CardTitle>
            </CardHeader>
            <CardContent>
              <Graficos />
            </CardContent>
          </Card>
          
          <Card>
            <CardHeader>
              <CardTitle>Memória de Cálculo</CardTitle>
            </CardHeader>
            <CardContent>
              <TabelaMemoriaCalculo />
            </CardContent>
          </Card>
        </TabsContent>
        
        <TabsContent value="financiamento" className="space-y-6">
          <Financiamento />
        </TabsContent>
      </Tabs>
    </div>
  );
}

export default App;
